<div
  class="markdown prose dark:prose-invert w-full break-words dark markdown-new-styling"
>
  <p data-start="0" data-end="188">
    De acuerdo. Te dejo un
    <strong data-start="23" data-end="72"
      >todo list claro, accionable y en orden lÃ³gico</strong
    >, pensado para que cuando vuelvas
    <strong data-start="106" data-end="139"
      >no tengas que re-razonar nada</strong
    >
    y puedas continuar exactamente donde lo dejamos.
  </p>
  <hr data-start="190" data-end="193" />
  <h1 data-start="195" data-end="252">
    ğŸ§¾ TODO LIST â€” Flujo completo Form Ingreso (sin wizard)
  </h1>
  <h2 data-start="254" data-end="281">ğŸ”¹ 1. Backend â€“ Clientes</h2>
  <ul class="contains-task-list" data-start="282" data-end="591">
    <li class="task-list-item" data-start="282" data-end="330">
      <p data-start="288" data-end="330">
        <input disabled="" type="checkbox" checked="" /> Exponer
        <code data-start="296" data-end="303">isNew</code> en
        <code data-start="307" data-end="330">buscarClientesService</code>
      </p>
    </li>
    <li data-start="331" data-end="405" class="task-list-item">
      <p data-start="337" data-end="405">
        <input disabled="" type="checkbox" checked="" /> Unificar semÃ¡ntica
        <code data-start="356" data-end="363">isNew</code> (autocomplete +
        intenciÃ³n + 0 resultados)
      </p>
    </li>
    <li data-start="406" data-end="451" class="task-list-item">
      <p data-start="412" data-end="451">
        <input disabled="" type="checkbox" checked="" /> Resolver
        <code data-start="421" data-end="428">query</code> genÃ©rico en
        controller
      </p>
    </li>
    <li class="task-list-item" data-start="452" data-end="523">
      <p data-start="454" data-end="523">
        <input disabled="" type="checkbox" />
        <strong data-start="458" data-end="523"
          >Crear endpoint
          <code data-start="475" data-end="496">crearClienteService</code>
          usable desde FormIngreso</strong
        >
      </p>
    </li>
    <li class="task-list-item" data-start="524" data-end="591">
      <p data-start="530" data-end="591">
        <input disabled="" type="checkbox" /> Asegurar que
        <code data-start="543" data-end="564">crearClienteService</code>
        devuelva <code data-start="574" data-end="579">_id</code> normalizado
      </p>
    </li>
  </ul>
  <hr data-start="593" data-end="596" />
  <h2 data-start="598" data-end="624">ğŸ”¹ 2. Backend â€“ Equipos</h2>
  <ul class="contains-task-list" data-start="625" data-end="914">
    <li class="task-list-item" data-start="625" data-end="673">
      <p data-start="631" data-end="673">
        <input disabled="" type="checkbox" checked="" /> Unificar
        <code data-start="640" data-end="647">isNew</code> en
        <code data-start="651" data-end="673">buscarEquiposService</code>
      </p>
    </li>
    <li class="task-list-item" data-start="674" data-end="705">
      <p data-start="680" data-end="705">
        <input disabled="" type="checkbox" checked="" /> Eliminar
        <code data-start="689" data-end="699">exists()</code> extra
      </p>
    </li>
    <li class="task-list-item" data-start="706" data-end="742">
      <p data-start="712" data-end="742">
        <input disabled="" type="checkbox" checked="" /> Alinear lookup vs
        autocomplete
      </p>
    </li>
    <li class="task-list-item" data-start="743" data-end="788">
      <p data-start="749" data-end="788">
        <input disabled="" type="checkbox" checked="" /> Resolver
        <code data-start="758" data-end="765">query</code> genÃ©rico en
        controller
      </p>
    </li>
    <li class="task-list-item" data-start="789" data-end="834">
      <p data-start="791" data-end="834">
        <input disabled="" type="checkbox" />
        <strong data-start="795" data-end="834"
          >Crear endpoint
          <code data-start="812" data-end="832"
            >crearEquipoService</code
          ></strong
        >
      </p>
    </li>
    <li class="task-list-item" data-start="835" data-end="914">
      <p data-start="841" data-end="866">
        <input disabled="" type="checkbox" /> Vincular automÃ¡ticamente:
      </p>
      <ul data-start="869" data-end="914">
        <li data-start="869" data-end="886">
          <p data-start="871" data-end="886">
            <code data-start="871" data-end="886">clienteActual</code>
          </p>
        </li>
        <li data-start="889" data-end="914">
          <p data-start="891" data-end="914">
            <code data-start="891" data-end="914">historialPropietarios</code>
          </p>
        </li>
      </ul>
    </li>
  </ul>
  <hr data-start="916" data-end="919" />
  <h2 data-start="921" data-end="957">ğŸ”¹ 3. Backend â€“ Reglas de dominio</h2>
  <ul data-start="958" data-end="1157" class="contains-task-list">
    <li data-start="958" data-end="1056" class="task-list-item">
      <p data-start="964" data-end="976">
        <input disabled="" type="checkbox" /> Validar que:
      </p>
      <ul data-start="979" data-end="1056">
        <li data-start="979" data-end="1020">
          <p data-start="981" data-end="1020">
            Un equipo <strong data-start="991" data-end="1000">nunca</strong> se
            cree sin cliente
          </p>
        </li>
        <li data-start="1023" data-end="1056">
          <p data-start="1025" data-end="1056">
            <code data-start="1025" data-end="1040">clienteActual</code> sea
            obligatorio
          </p>
        </li>
      </ul>
    </li>
    <li class="task-list-item" data-start="1057" data-end="1157">
      <p data-start="1063" data-end="1082">
        <input disabled="" type="checkbox" /> Normalizar errores:
      </p>
      <ul data-start="1085" data-end="1157">
        <li data-start="1085" data-end="1120">
          <p data-start="1087" data-end="1120">
            Cliente no creado â†’ abortar flujo
          </p>
        </li>
        <li data-start="1123" data-end="1157">
          <p data-start="1125" data-end="1157">
            Equipo no creado â†’ abortar flujo
          </p>
        </li>
      </ul>
    </li>
  </ul>
  <hr data-start="1159" data-end="1162" />
  <h2 data-start="1164" data-end="1205">
    ğŸ”¹ 4. Frontend â€“ Context (IngresoForm)
  </h2>
  <ul class="contains-task-list" data-start="1206" data-end="1421">
    <li class="task-list-item" data-start="1206" data-end="1265">
      <p data-start="1212" data-end="1242">
        <input disabled="" type="checkbox" /> Introducir bandera
        <code data-start="1231" data-end="1238">isNew</code> en:
      </p>
      <ul data-start="1245" data-end="1265">
        <li data-start="1245" data-end="1254">
          <p data-start="1247" data-end="1254">cliente</p>
        </li>
        <li data-start="1257" data-end="1265">
          <p data-start="1259" data-end="1265">equipo</p>
        </li>
      </ul>
    </li>
    <li class="task-list-item" data-start="1266" data-end="1363">
      <p data-start="1272" data-end="1296">
        <input disabled="" type="checkbox" /> Mantener shape uniforme:
      </p>
      <pre
        class="overflow-visible! px-0!"
        data-start="1299"
        data-end="1363"
      ><div class="contain-inline-size rounded-2xl corner-superellipse/1.1 relative bg-token-sidebar-surface-primary"><div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl corner-t-superellipse/1.1">js</div><div class="@w-xl/main:top-9 sticky top-[calc(--spacing(9)+var(--header-height))]"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1" aria-label="Copiar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" aria-hidden="true" class="icon-sm"><use href="/cdn/assets/sprites-core-btjmrd1b.svg#ce3544" fill="currentColor"></use></svg>Copiar cÃ³digo</button></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-js"><span><span>{
  value,
  label,
  isNew,
  payload
}
</span></span></code></div></div></pre>
    </li>
    <li class="task-list-item" data-start="1364" data-end="1421">
      <p data-start="1370" data-end="1421">
        <input disabled="" type="checkbox" /> Sincronizar context â†’ formState â†’
        buildOrdenPayload
      </p>
    </li>
  </ul>
  <hr data-start="1423" data-end="1426" />
  <h2 data-start="1428" data-end="1473">
    ğŸ”¹ 5. Frontend â€“ Submit Orquestado (CLAVE)
  </h2>
  <ul class="contains-task-list" data-start="1474" data-end="1732">
    <li class="task-list-item" data-start="1474" data-end="1690">
      <p data-start="1480" data-end="1494">
        <input disabled="" type="checkbox" /> En
        <code data-start="1483" data-end="1493">onSubmit</code>:
      </p>
      <ol data-start="1497" data-end="1690">
        <li data-start="1497" data-end="1534">
          <p data-start="1500" data-end="1534">
            Si <code data-start="1503" data-end="1518">cliente.isNew</code> â†’
            crear cliente
          </p>
        </li>
        <li data-start="1537" data-end="1594">
          <p data-start="1540" data-end="1594">
            Si <code data-start="1543" data-end="1557">equipo.isNew</code> â†’
            crear equipo (usar cliente creado)
          </p>
        </li>
        <li data-start="1597" data-end="1627">
          <p data-start="1600" data-end="1627">Reemplazar IDs en formState</p>
        </li>
        <li data-start="1630" data-end="1661">
          <p data-start="1633" data-end="1661">
            Ejecutar
            <code data-start="1642" data-end="1661">buildOrdenPayload</code>
          </p>
        </li>
        <li data-start="1664" data-end="1690">
          <p data-start="1667" data-end="1690">Crear Orden de Servicio</p>
        </li>
      </ol>
    </li>
    <li class="task-list-item" data-start="1691" data-end="1732">
      <p data-start="1697" data-end="1732">
        <input disabled="" type="checkbox" /> Manejar errores con rollback
        lÃ³gico
      </p>
    </li>
  </ul>
  <hr data-start="1734" data-end="1737" />
  <h2 data-start="1739" data-end="1755">ğŸ”¹ 6. UX / DX</h2>
  <ul class="contains-task-list" data-start="1756" data-end="1939">
    <li class="task-list-item" data-start="1756" data-end="1795">
      <p data-start="1762" data-end="1795">
        <input disabled="" type="checkbox" /> Mantener
        <strong data-start="1771" data-end="1795">un solo botÃ³n submit</strong>
      </p>
    </li>
    <li class="task-list-item" data-start="1796" data-end="1812">
      <p data-start="1802" data-end="1812">
        <input disabled="" type="checkbox" /> No modales
      </p>
    </li>
    <li class="task-list-item" data-start="1813" data-end="1841">
      <p data-start="1819" data-end="1841">
        <input disabled="" type="checkbox" /> No submits intermedios
      </p>
    </li>
    <li class="task-list-item" data-start="1842" data-end="1939">
      <p data-start="1848" data-end="1871">
        <input disabled="" type="checkbox" /> Mostrar feedback claro:
      </p>
      <ul data-start="1874" data-end="1939">
        <li data-start="1874" data-end="1894">
          <p data-start="1876" data-end="1894">â€œCreando clienteâ€¦â€</p>
        </li>
        <li data-start="1897" data-end="1916">
          <p data-start="1899" data-end="1916">â€œCreando equipoâ€¦â€</p>
        </li>
        <li data-start="1919" data-end="1939">
          <p data-start="1921" data-end="1939">â€œGuardando ordenâ€¦â€</p>
        </li>
      </ul>
    </li>
  </ul>
  <hr data-start="1941" data-end="1944" />
  <h2 data-start="1946" data-end="1975">ğŸ”¹ 7. Seguridad / Robustez</h2>
  <ul class="contains-task-list" data-start="1976" data-end="2102">
    <li class="task-list-item" data-start="1976" data-end="2024">
      <p data-start="1982" data-end="1990">
        <input disabled="" type="checkbox" /> Backend:
      </p>
      <ul data-start="1993" data-end="2024">
        <li data-start="1993" data-end="2024">
          <p data-start="1995" data-end="2024">Validar IDs antes de crear OS</p>
        </li>
      </ul>
    </li>
    <li class="task-list-item" data-start="2025" data-end="2102">
      <p data-start="2031" data-end="2040">
        <input disabled="" type="checkbox" /> Frontend:
      </p>
      <ul data-start="2043" data-end="2102">
        <li data-start="2043" data-end="2081">
          <p data-start="2045" data-end="2081">
            Bloquear submit mientras se orquesta
          </p>
        </li>
        <li data-start="2084" data-end="2102">
          <p data-start="2086" data-end="2102">Reintento seguro</p>
        </li>
      </ul>
    </li>
  </ul>
  <hr data-start="2104" data-end="2107" />
  <h2 data-start="2109" data-end="2132">ğŸ”¹ 8. Limpieza final</h2>
  <ul class="contains-task-list" data-start="2133" data-end="2270">
    <li class="task-list-item" data-start="2133" data-end="2179">
      <p data-start="2139" data-end="2179">
        <input disabled="" type="checkbox" /> Eliminar lÃ³gica duplicada wizard /
        panel
      </p>
    </li>
    <li class="task-list-item" data-start="2180" data-end="2236">
      <p data-start="2186" data-end="2236">
        <input disabled="" type="checkbox" /> Dejar
        <code data-start="2192" data-end="2218">buildIngresoInitialState</code>
        como Ãºnica fuente
      </p>
    </li>
    <li class="task-list-item" data-start="2237" data-end="2270">
      <p data-start="2243" data-end="2270">
        <input disabled="" type="checkbox" /> Documentar contrato
        <code data-start="2263" data-end="2270">isNew</code>
      </p>
    </li>
  </ul>
  <hr data-start="2272" data-end="2275" />
  <h2 data-start="2277" data-end="2306">ğŸ§  Nota final (importante)</h2>
  <p data-start="2308" data-end="2323">Cuando retomes:</p>
  <ul data-start="2324" data-end="2411">
    <li data-start="2324" data-end="2359">
      <p data-start="2326" data-end="2359">
        <strong data-start="2326" data-end="2339">NO toques</strong>
        <code data-start="2340" data-end="2359">buildOrdenPayload</code>
      </p>
    </li>
    <li data-start="2360" data-end="2385">
      <p data-start="2362" data-end="2385">
        <strong data-start="2362" data-end="2385">NO agregues botones</strong>
      </p>
    </li>
    <li data-start="2386" data-end="2411">
      <p data-start="2388" data-end="2411">
        <strong data-start="2388" data-end="2411">NO agregues modales</strong>
      </p>
    </li>
  </ul>
  <p data-start="2413" data-end="2469">
    Todo el diseÃ±o ya estÃ¡ preparado para el flujo correcto.
  </p>
  <hr data-start="2471" data-end="2474" />
  <p
    data-start="2476"
    data-end="2610"
    data-is-last-node=""
    data-is-only-node=""
  >
    Cuando vuelvas y tengas energÃ­a:<br />
    ğŸ‘‰ dime
    <strong data-start="2517" data-end="2549"
      >â€œretomamos desde el punto Xâ€</strong
    ><br data-start="2549" data-end="2552" />
    y seguimos exactamente desde ahÃ­, sin pÃ©rdida de contexto. ATENCION ğŸ“Œ
    Prompt recomendado â€” DiseÃ±o de contrato de dominio (Orden de Servicio) ActÃºa
    como un arquitecto de software senior full-stack, con experiencia en DDD
    ligero, APIs REST transaccionales y formularios complejos con autosave.
    Tengo una aplicaciÃ³n con un formulario de Orden de Servicio que puede
    incluir: Cliente (existente o nuevo) Equipo (existente o nuevo) TÃ©cnico
    (existente) LÃ­neas de servicio Actualmente: El frontend trabaja con estados
    normalizados El autosave guarda intenciÃ³n, no estados backend Existen
    endpoints separados: /clientes /equipos /ordenes-servicio Quiero diseÃ±ar un
    contrato de dominio definitivo para el endpoint: POST /ordenes-servicio
    Objetivos del diseÃ±o: Permitir referenciar entidades existentes por ID
    Permitir crear entidades nuevas en el mismo submit Mantener atomicidad total
    (todo o nada) Centralizar validaciones en backend Evitar submits encadenados
    desde el frontend Ser compatible con autosave y futuros cambios de esquema
    QuÃ© necesito que definas: ğŸ“¦ Estructura exacta del payload (JSON)
    Diferenciando claramente ref vs create ğŸ§  Reglas de validaciÃ³n backend para
    cada caso ğŸ” Flujo lÃ³gico interno del backend (resoluciÃ³n de entidades) âŒ
    Manejo de errores y respuestas esperadas ğŸ§© CÃ³mo convive este endpoint con
    los endpoints /clientes y /equipos ğŸ”® Consideraciones de escalabilidad y
    versionado del contrato Contexto importante: El frontend no debe decidir si
    crear o no definitivamente entidades El backend es el orquestador del
    proceso No quiero soluciones â€œwizard backendâ€ ni mÃºltiples requests Dame una
    propuesta clara, prÃ¡ctica y lista para implementar, con ejemplos concretos y
    justificaciÃ³n tÃ©cnica. ğŸ§  Por quÃ© este prompt funciona bien Te posiciona
    correctamente (no como junior) Define lÃ­mites claros de responsabilidad
    Evita soluciones frÃ¡giles Obliga a pensar en contrato, no en implementaciÃ³n
    puntual Es compatible con todo lo que ya construiste Cuando maÃ±ana vuelvas y
    pegues ese prompt, podremos: DiseÃ±ar el payload final Simular validaciones
    reales Alinear frontend + backend sin rehacer nada Buen trabajo hoy. Has
    avanzado mucho mÃ¡s que el paso 1, y con criterio.
  </p>
  <p>
    La Ãºnica recomendaciÃ³n fuerte que te dejo es esta: No mezcles estado UI con
    intenciÃ³n de creaciÃ³n SepÃ¡ralos y todo lo demÃ¡s fluye solo. Cuando maÃ±ana
    quieras, el siguiente paso natural es: Definir el payload final exacto de
    POST /ordenes-servicio O escribir el pseudo-cÃ³digo del submit orquestado
    Buen trabajo. Esto ya es arquitectura, no debugging.
  </p>
</div>
